<!DOCTYPE html>

<html>

<head>
<style>
#info {
  position: absolute;
  top: 0px;
  width: 100%;
  padding: 10px;
  text-align: center;
  color: #ffff00
}

body {
  overflow: hidden;
}
</style>
</head>

<body> 
<div id="info">HW3
<br>
<button id="camera" onclick="ButtonEvent(event)">Switch View</button>
</div>
<script src="https://threejs.org/build/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>
<script src="https://raw.githack.com/mrdoob/three.js/dev/examples/js/misc/Gyroscope.js"></script>
<script src="model.js"></script>
<script src="keyframes.js"></script>

<script>
//javascript:(function(){var script=document.createElement('script');script.onload=function(){var stats=new Stats();document.body.appendChild(stats.dom);requestAnimationFrame(function loop(){stats.update();requestAnimationFrame(loop)});};script.src='https://mrdoob.github.io/stats.js/build/stats.min.js';document.head.appendChild(script);})()

var camera, camera1, scene, renderer;
const WW = 4;
const HH = 12;
var head, torso, lLeg, rLeg, lArm, rArm;
var intKey
var walk = false;
var clock = new THREE.Clock();
var ts, state = 'Stand';
var  keyboard = new KeyboardState();
var  speed=0,angle=0,vel=0,flag=0;
var  pos = new THREE.Vector3();
var gyro, gyroMode = 0;
var cam_mode = 0;
// three STATES: Walk, S2W, Stand
(function() {
  Math.clamp = function(val,min,max){
    return Math.min(Math.max(val,min),max);
    
  }})();
  
init();
animate();


function init() {

  scene = new THREE.Scene();

  renderer = new THREE.WebGLRenderer({antialias: true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x888888);
  document.body.appendChild(renderer.domElement);

  camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 1000);
  camera.position.set(0, 100, 125);
  camera1 = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 1000);
  camera1.position.set(0, 100, 125);

  document.addEventListener('pointerdown', PointerDown, false);
  let controls = new THREE.OrbitControls(camera, renderer.domElement);
  var gridXZ = new THREE.GridHelper(200, 20, 'red', 'white');
  scene.add(gridXZ);

  buildSteve();

  ts = clock.getElapsedTime();
  window.addEventListener('resize', onWindowResize, false);
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}


function PointerDown(event) {
  if (event.button == 0) {
    console.log('left button down');
  }
}

function update(dt) {

  keyboard.update();
	if ( keyboard.pressed("left") ) 
		angle += 0.01;               
	if ( keyboard.pressed("right") )
		angle -= 0.01;               
	if ( keyboard.pressed("space") ){  
		
		speed += 0.5;   
	}
	speed = Math.clamp (speed, 0.1, 20.0);		
	vel = new THREE.Vector3(speed,0,0);
	
	vel.applyAxisAngle (new THREE.Vector3(0,1,0), angle);
	pos.add (vel.clone().multiplyScalar(dt)); 	
}

function animate() {
	var dt = clock.getDelta();
  update(dt);
  
  torso.position.copy(pos);
  torso.position.y+=HH;
  torso.rotation.y = Math.PI / 2+angle;
  requestAnimationFrame(animate);
  render();
  
  let intKey;
  
	if (keyboard.down('space')) state='Walk';
  
  if (keyboard.up('space')) { 
    ts = clock.getElapsedTime();
    state = 'S2W';
    let intKey = keyframeS2W(ts, TS2W);
    lLeg.rotation.x = intKey[0];
    rLeg.rotation.x = intKey[1];
  }
  
  if ( keyboard.down("left") )state='Walk';  
  if ( keyboard.down("right") )state='Walk'; 
  if ( keyboard.up("left") && speed<=0 )state='Stand';	
  if ( keyboard.up("right") && speed<=0 )state='Stand';
  
 
  switch (state) {
    case 'Stand':
      intKey = keyframeStand(clock.getElapsedTime(), TStand);
      break;
    case 'S2W':
      intKey = keyframeS2W(clock.getElapsedTime(), TS2W);
      break;
    case 'Walk':
      intKey = keyframeWalk(clock.getElapsedTime(), TWalk);
      break;
  }
  
  lArm.rotation.x = intKey[1];
  rArm.rotation.x = intKey[0];
  lLeg.rotation.x = intKey[0];
  rLeg.rotation.x = intKey[1];
  
  camera1.lookAt (torso.position);
  
  if (gyroMode==1) renderer.render (scene, camera);
  else	renderer.render (scene, camera1); 
  changeview();
}

function render() {

  renderer.render(scene, camera);

}
function ButtonEvent(){
  if(cam_mode == 0){
    cam_mode = 1;
  }
  else{
    /*
    camera.position.x = 0;
	camera.position.y = 300;
	camera.position.z = 500; 
	*/
	camera.position.set(0,100,125);
    cam_mode = 0;
  }
}
function changeview(){
  if(cam_mode == 1){
    let cameraPos = new THREE.Vector3(0,12*WW,-50*WW);
    head.localToWorld (cameraPos);
    camera.position.copy (cameraPos);
    let cameraLookAt = new THREE.Vector3(0,2*WW,-10);
    head.localToWorld (cameraLookAt);
    camera.lookAt (cameraLookAt);
  }
  else{
    let cameraLookAt = new THREE.Vector3(0,0,-1);
    camera.lookAt (cameraLookAt);
  }
}
</script>
</body>

</html>